{% extends 'gestionCreneaux/base.html' %}
{% block body %}
{% csrf_token %}
{% include 'menu.html'%}

<style>
.fc .fc-scrollgrid-section-header.fc-scrollgrid-section-sticky>* {
  top: 58px;
}

.event-jeulibre {
  background-color : green;
}

.event-tournoi {
  background-color : orange;
}

.event-jeulibreinscription {
  background-color : blue;
}

.event-enattente {
  background-color : gray;
}

</style>
<script>
  function api_call(nom,donnees,retour) {
            var formData = new FormData();
            for (x in donnees) {
              formData.append(x,donnees[x])
            }
            csrf=document.getElementsByName('csrfmiddlewaretoken')[0]
            formData.append('csrfmiddlewaretoken',csrf.value)
            fetch(nom, {
              method : 'POST',
              headers : {
                'Accept': 'application/json, text/plain, */*',
                },
                body: formData
            }).then(function(res){ return res.json();})
              .then(function(res){
                retour(res)
               })
                .catch(function(err){ console.log('Erreur requête', err);});
        }
</script>

<div id='calendar'></div>
<div class="modal fade" id="myModal" role="dialog" tabindex="-1"  aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 id="modal_titre" class="modal-title w-100 font-weight-bold"></h4>
      </div>
      <div id="modalBody" class="modal-body mx-3"></div>
      <div class="modal-footer d-flex justify-content-center">
 {% if admin %}  <button class="btn btn-success" id="bouton-modifier" data-dismiss="modal"> Modifier le créneau </button> {% endif%}
        <button class="btn btn-success" id="bouton-inscription" data-dismiss="modal"> </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal"> Fermer </button>
      </div>
    </div>
  </div>
</div>


{% if admin %}
<div class="modal fade" id="myModalAd" role="dialog" tabindex="-1"  aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 id="modal_titreAd" class="modal-title w-100 font-weight-bold">Création de créneau</h4>
      </div>
      <div id="modalBodyAdbis" class="modal-body mx-3"></div>
      <div id="modalBodyAd" class="modal-body mx-3"></div>
      <div class="modal-footer d-flex justify-content-center">
        <button class="btn btn-success" id="bouton-creationAd" data-dismiss="modal"> Créer le créneau</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal"> Fermer </button>
      </div>
    </div>
  </div>
</div>
      {% endif %}

<script>
  "use strict";
  var calendar ;
   function clickbutton(id,cmd) { 
        api_call("/gestionCreneaux/click",{"id" : id,"cmd" : cmd},function (res) { 
          calendar.refetchEvents();})
      }
      {% if admin%}
    function creation() {
        api_call("/gestionAdmin/creation",{"debut" : $('#modalBodyAdbis').text()},function (res) { 
          calendar.refetchEvents();})
    }{% endif %}

  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
            schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
            headerToolbar: {
                left: 'prev,next',
                right: 'timeGridDay,TimeGridThreeDay,timeGridWeek,dayGridMonth'
            },
            views: {
              timeGridDay :{
                buttonText: '1 jour'
              },
              TimeGridThreeDay: {
                type: 'timeGridDay',
                duration: { days: 3 },
                buttonText: '3 jours'
              },
              timeGridWeek :{
                buttonText: '7 jours'
              },
              dayGridMonth :{
                buttonText: '1 mois',
                dayMaxEvents : 3
              },
            },
            initialView : 'TimeGridThreeDay',
            contentHeight: 'auto',
            stickyHeaderDates : true,
            locale : 'fr',
            firstDay : 1, // commence le lundi
            allDaySlot : false,
            slotMinTime : "08:00:00",
            //scrollTime : "11:00:00",   // non utilisé avec contenHeight auto ???
            eventClick: function(info) {
              $('#modal_titre').html(info.event.title);
              $('#modalBody').html(info.event.extendedProps.body);
              if (info.event.extendedProps.inscription) {
                $('#bouton-inscription').text(info.event.extendedProps.inscription);
                $('#bouton-inscription').attr('onclick','clickbutton('+info.event.id.toString()+','+info.event.extendedProps.cmd+')')
                $('#bouton-inscription').show();
              } else {
                $('#bouton-inscription').hide()
              } {% if admin %}
                $('#bouton-modifier').attr('onclick','alert("créneau '+info.event.id.toString()+' à modifier")')
                {% endif %}
              $('#myModal').modal();
            },{% if admin %}
            dateClick: function(info) {
              $('#modalBodyAd').html("pour la création de créneau pour : "+ info.dateStr+', Coordinates: ' + info.jsEvent.pageX + ',' + info.jsEvent.pageY+', Current view: ' + info.view.type);
              $('#modalBodyAdbis').html(info.dateStr);
              $('#bouton-creationAd').attr('onclick','creation()')
              $('#myModalAd').modal();
            }, {% endif %}
            events: '/gestionCreneaux/events',
    });


      //ajout de la gestion du swipe
      let touchStartX = 0;
      let touchEndX = 0;

      calendarEl.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      });

      calendarEl.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleGesture();
      });

      function handleGesture() {
        const swipeThreshold = 50; // distance minimale en px
        const deltaX = touchEndX - touchStartX;

        if (Math.abs(deltaX) > swipeThreshold) {
          if (deltaX < 0) {
            // Swipe gauche → jour suivant
            calendar.next();
          } else {
            // Swipe droite → jour précédent
            calendar.prev();
          }
        }
      }

    calendar.render();
    //tmp pour la taille de l'écran
    document.getElementById("navbarSupportedContent").insertAdjacentHTML('beforebegin',"  "+screen.width + "x" + screen.height)
  });

</script>
{% endblock body %}

